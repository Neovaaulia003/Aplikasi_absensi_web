<!DOCTYPE html> 
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Absensi Guru MAS Ainul Amin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box;font-family:'Segoe UI',sans-serif}
body{margin:0;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh}
.hidden{display:none}
.login-box{max-width:380px;margin:90px auto;background:#fff;padding:35px;border-radius:22px}
select,input,button{width:100%;padding:13px;margin-top:12px;border-radius:12px}
button.primary{background:#1e3c72;color:#fff;border:none}
button.danger{background:#dc3545;color:#fff;border:none}
.sidebar{position:fixed;left:0;top:0;width:240px;height:100vh;background:#1e3c72;color:#fff;padding:25px}
.main{margin-left:240px;padding:30px}
.card{background:#fff;padding:25px;border-radius:20px;margin-bottom:25px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#1e3c72;color:#fff}
video,canvas,img{border-radius:12px;border:3px solid #1e3c72}
.badge-ok{background:#28a745;color:#fff;padding:6px 10px;border-radius:12px}
.badge-no{background:#dc3545;color:#fff;padding:6px 10px;border-radius:12px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="login-box">
<h3>LOGIN SISTEM ABSENSI</h3>
<select id="role">
<option value="guru">Guru</option>
<option value="admin">Admin</option>
<option value="operator">Operator</option>
<option value="tu">Staff TU</option>
</select>
<input id="namaGuru" placeholder="Nama">
<input id="nipGuru" placeholder="NIP">
<button class="primary" onclick="login()">Masuk</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar hidden">
<h3 id="roleTitle"></h3>
<button onclick="switchRole('guru')">Dashboard Guru</button>
<button onclick="switchRole('admin')">Admin</button>
<button onclick="switchRole('operator')">Operator</button>
<button onclick="switchRole('tu')">Staff TU</button>
<button onclick="logout()">Logout</button>
</div>

<!-- MAIN -->
<div id="main" class="main hidden">

<!-- DASHBOARD GURU -->
<div id="guruDash" class="hidden">
<div class="card">
<h3>üìç Lokasi Guru</h3>
<p><b>MAS Ainul Amin Tebing Tinggi</b></p>
<p id="statusLokasi">Mendeteksi lokasi...</p>
</div>

<div class="card">
<h3>üì∏ Scan Wajah Guru</h3>
<video id="video" autoplay playsinline width="240"></video>
<canvas id="canvas" class="hidden"></canvas><br>
<button class="primary" onclick="startCamera()">Aktifkan Kamera</button>
<button class="primary" onclick="scanMasuk()">Scan Masuk</button>
<button class="danger" onclick="scanKeluar()">Scan Keluar</button>
</div>

<div class="card">
<h3>Riwayat Absensi Guru</h3>
<table>
<thead>
<tr>
<th>Tanggal</th><th>Masuk</th><th>Keluar</th>
<th>Foto Masuk</th><th>Foto Keluar</th><th>Lokasi</th>
</tr>
</thead>
<tbody id="riwayatGuru"></tbody>
</table>
</div>
</div>

<div id="adminDash" class="hidden"></div>
<div id="operatorDash" class="hidden"></div>
<div id="tuDash" class="hidden"></div>

</div>

<script>
let absensiData=[];
let fotoMasuk="", fotoKeluar="", lokasiText="";

/* LOGIN */
function login(){
loginPage.classList.add("hidden");
sidebar.classList.remove("hidden");
main.classList.remove("hidden");
switchRole(role.value);
}
function switchRole(r){
roleTitle.innerText=r.toUpperCase();
["guruDash","adminDash","operatorDash","tuDash"].forEach(d=>document.getElementById(d).classList.add("hidden"));
document.getElementById(r+"Dash").classList.remove("hidden");
renderAll();
if(r==="guru") cekLokasiGuru();
}
function logout(){location.reload();}

/* KAMERA */
function startCamera(){
navigator.mediaDevices.getUserMedia({video:true})
.then(stream=>video.srcObject=stream)
.catch(()=>alert("Kamera tidak dapat diakses"));
}
function scanMasuk(){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext("2d").drawImage(video,0,0);
fotoMasuk=canvas.toDataURL("image/png");
simpanAbsensi("Masuk");
}
function scanKeluar(){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext("2d").drawImage(video,0,0);
fotoKeluar=canvas.toDataURL("image/png");
simpanAbsensi("Keluar");
}

/* SIMPAN ABSEN */
function simpanAbsensi(jenis){
let tgl=new Date().toLocaleDateString();
let jam=new Date().toLocaleTimeString();
let data=absensiData.find(a=>a.tanggal===tgl && a.nama===namaGuru.value);
if(!data){
data={nama:namaGuru.value,nip:nipGuru.value,tanggal:tgl};
absensiData.push(data);
}
data[jenis.toLowerCase()]=jam;
data["foto"+jenis]=jenis==="Masuk"?fotoMasuk:fotoKeluar;
data.lokasi=lokasiText;
renderAll();
}

/* EXPORT */
function exportExcel(){
let ws=XLSX.utils.json_to_sheet(absensiData);
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Absensi");
XLSX.writeFile(wb,"Absensi_Guru_MAS_Ainul_Amin.xlsx");
}
function exportPDF(){
const {jsPDF}=window.jspdf;
let doc=new jsPDF();
doc.text("Laporan Absensi Guru",14,15);
doc.autoTable({
startY:20,
head:[["Nama","NIP","Tanggal","Masuk","Keluar","Lokasi"]],
body:absensiData.map(a=>[a.nama,a.nip,a.tanggal,a.masuk,a.keluar,a.lokasi])
});
doc.save("Absensi_Guru.pdf");
}

/* RENDER RIWAYAT SEMUA DASHBOARD */
function renderAll(){
riwayatGuru.innerHTML=absensiData.map(a=>`
<tr>
<td>${a.tanggal||""}</td>
<td>${a.masuk||""}</td>
<td>${a.keluar||""}</td>
<td>${a.fotoMasuk?`<img src="${a.fotoMasuk}" width="40">`:""}</td>
<td>${a.fotoKeluar?`<img src="${a.fotoKeluar}" width="40">`:""}</td>
<td>${a.lokasi||""}</td>
</tr>`).join("");

["adminDash","operatorDash","tuDash"].forEach(id=>{
document.getElementById(id).innerHTML=`
<div class="card">
<h3>üìä Riwayat Absensi Guru</h3>
<button class="primary" onclick="exportExcel()">Export Excel</button>
<button class="primary" onclick="exportPDF()">Export PDF</button>
<table>
<thead>
<tr>
<th>Nama</th><th>NIP</th><th>Tanggal</th>
<th>Masuk</th><th>Keluar</th><th>Lokasi</th>
</tr>
</thead>
<tbody>
${absensiData.map(a=>`
<tr>
<td>${a.nama||""}</td>
<td>${a.nip||""}</td>
<td>${a.tanggal||""}</td>
<td>${a.masuk||""}</td>
<td>${a.keluar||""}</td>
<td>${a.lokasi||""}</td>
</tr>`).join("")}
</tbody>
</table>
</div>`;
});
}

/* GPS */
const sekolahLat=3.3285, sekolahLng=99.1446;
const radiusMeter=100000000*1000;
function hitungJarak(lat1,lon1,lat2,lon2){
const R=6371000;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}
function cekLokasiGuru(){
navigator.geolocation.getCurrentPosition(pos=>{
let jarak=hitungJarak(pos.coords.latitude,pos.coords.longitude,sekolahLat,sekolahLng);
if(jarak<=radiusMeter){
lokasiText="MAS Ainul Amin Tebing Tinggi";
statusLokasi.innerHTML=`<span class="badge-ok">Lokasi Valid</span>`;
}else{
lokasiText="Di luar area";
statusLokasi.innerHTML=`<span class="badge-no">Di luar radius</span>`;
}
});
}
</script>

<script>
/* =====================================
   EXPORT EXCEL FINAL (OVERRIDE AMAN)
   ===================================== */
function exportExcel(){
  if(absensiData.length === 0){
    alert("Belum ada data absensi");
    return;
  }

  const dataExcel = absensiData.map(a => ({
    "Nama Guru"   : a.nama || "",
    "NIP"         : a.nip || "",
    "Tanggal"     : a.tanggal || "",
    "Jam Masuk"   : a.masuk || "",
    "Jam Keluar"  : a.keluar || "",
    "Lokasi"      : a.lokasi || ""
  }));

  const worksheet = XLSX.utils.json_to_sheet(dataExcel);
  const workbook  = XLSX.utils.book_new();

  XLSX.utils.book_append_sheet(
    workbook,
    worksheet,
    "Absensi Guru"
  );

  XLSX.writeFile(
    workbook,
    "Absensi_Guru_MAS_Ainul_Amin.xlsx"
  );
}
</script>

<script>
/* =====================================
   EDIT & HAPUS DATA ABSENSI (ADMIN/OP/TU)
   ===================================== */

function editAbsensi(index){
  let a = absensiData[index];
  if(!a) return;

  let nama   = prompt("Edit Nama Guru:", a.nama);
  let nip    = prompt("Edit NIP:", a.nip);
  let tanggal= prompt("Edit Tanggal:", a.tanggal);
  let masuk  = prompt("Edit Jam Masuk:", a.masuk);
  let keluar = prompt("Edit Jam Keluar:", a.keluar);
  let lokasi = prompt("Edit Lokasi:", a.lokasi);

  a.nama    = nama   ?? a.nama;
  a.nip     = nip    ?? a.nip;
  a.tanggal = tanggal?? a.tanggal;
  a.masuk   = masuk  ?? a.masuk;
  a.keluar  = keluar ?? a.keluar;
  a.lokasi  = lokasi ?? a.lokasi;

  renderAll();
}

function hapusAbsensi(index){
  if(confirm("Yakin ingin menghapus data absensi ini?")){
    absensiData.splice(index,1);
    renderAll();
  }
}

/* =====================================
   OVERRIDE RENDER DASHBOARD ADMIN/OP/TU
   (TANPA MERUSAK KODE SEBELUMNYA)
   ===================================== */
const renderAllAsli = renderAll;

renderAll = function(){
  renderAllAsli();

  ["adminDash","operatorDash","tuDash"].forEach(id=>{
    document.getElementById(id).innerHTML = `
    <div class="card">
      <h3>üìä Riwayat Absensi Guru</h3>

      <button class="primary" onclick="exportExcel()">üì• Export Excel</button>
      <button class="primary" onclick="exportPDF()">üìÑ Export PDF</button>

      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>NIP</th>
            <th>Tanggal</th>
            <th>Masuk</th>
            <th>Keluar</th>
            <th>Lokasi</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          ${absensiData.map((a,i)=>`
          <tr>
            <td>${a.nama||""}</td>
            <td>${a.nip||""}</td>
            <td>${a.tanggal||""}</td>
            <td>${a.masuk||""}</td>
            <td>${a.keluar||""}</td>
            <td>${a.lokasi||""}</td>
            <td>
              <button class="warning" onclick="editAbsensi(${i})">‚úèÔ∏è Edit</button>
              <button class="danger" onclick="hapusAbsensi(${i})">üóë Hapus</button>
            </td>
          </tr>
          `).join("")}
        </tbody>
      </table>
    </div>`;
  });
}
</script>
<style>
/* ===============================
   RESPONSIVE MOBILE (HP)
   TANPA UBAH KODE SEBELUMNYA
   =============================== */
@media (max-width: 768px){

  body{
    background: linear-gradient(135deg,#1e3c72,#2a5298);
  }

  /* LOGIN */
  .login-box{
    margin:40px 15px;
    padding:25px;
  }

  /* SIDEBAR JADI TOP BAR */
  .sidebar{
    position:relative;
    width:100%;
    height:auto;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    padding:15px;
  }

  .sidebar h3{
    width:100%;
    text-align:center;
    margin-bottom:10px;
  }

  .sidebar button{
    flex:1 1 48%;
    font-size:14px;
    padding:10px;
  }

  /* MAIN FULL WIDTH */
  .main{
    margin-left:0;
    padding:15px;
  }

  /* CARD */
  .card{
    padding:18px;
    border-radius:16px;
  }

  /* VIDEO & GAMBAR */
  video{
    width:100%;
    max-width:100%;
    height:auto;
  }

  img{
    max-width:100%;
    height:auto;
  }

  /* TABLE SCROLL */
  table{
    display:block;
    overflow-x:auto;
    white-space:nowrap;
    font-size:13px;
  }

  th,td{
    padding:6px;
  }

  /* BUTTON */
  button{
    font-size:14px;
    padding:12px;
  }

}
</style>

</body>
</html>
